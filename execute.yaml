steps:
  # Step 1: Install the Cloud SQL Proxy
  - name: 'gcr.io/cloud-builders/docker'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        wget -O cloud_sql_proxy https://dl.google.com/cloudsql/cloud_sql_proxy.linux.amd64
        chmod +x cloud_sql_proxy

  # Step 2: Start the Cloud SQL Proxy and execute the SQL script
  - name: 'gcr.io/cloud-builders/gcloud'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        ./cloud_sql_proxy -instances=practice-377017:us-central1:quickstart-instance=tcp:5432 &
        sleep 5
        gsutil cp gs://bucket-shu/table.sql /tmp/table.sql
        psql -h 127.0.0.1 -U [quickstart-user] -d [quickstart-db] -f /tmp/table.sql

  # Step 3: Clean up the Cloud SQL Proxy
  - name: 'gcr.io/cloud-builders/docker'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        killall cloud_sql_proxy
        rm cloud_sql_proxy
